

2019边4月11日，华为新品发布会，发布P30和P30 pro。我在上班的时候瞄了几眼，发现发布会中有这么一段话：

> 华为带来了新的“方舟编译器”，它解决了安卓程序“边解释边执行”的低效。架构级的优化，华为表示可以显著提升性能。 
>
> 现有Android系统 存在边解释边执行的低效现象。
>
> 而使用华为方舟编译器，全程执行机器码高效运行程序。

这又是什么黑科技？

基于我那匮乏的知识，Android不是只有两种Dalvik 和Art 虚拟机吗？这个又是干嘛的？



说到编译器，就不虚说到Android的两种虚拟机，说到Android的虚拟机就不得不说到Java虚拟机（JVM）。



# 1. JVM、Dalvik 和 Art

### 1

Dalvik是Google对JVM的优化，适用于Android平台的Java虚拟机。

它对于JVM的区别有以下几点：

- Dalvik上运行的是.dex格式的字节码，而不是class文件，它是基于寄存器的架构，而JVM是基于栈的架构，因此在运行效率上要高那么一点。
- 一个应用对应一个Dalvik实例，每个应用都是独立运行的Linux进程，发生了Crash也不会影响到其它进程。

但是在实际的使用中，它依靠一个叫JIT（Just-In-Time）编译器去解释字节码，就是货真价实的一边运行一边编译的方式来运行App，造成了极其低下的代码执行效率。



#### 2

Android 5.0 后，Google推出了ART（Android Runtime）来解决JIT造成的代码执行效率问题。这种方式是完全的AOT（Ahead of time）模式。Android应用在安装之时会将所有的java代码编译成机器码，然后存储对应的机器码，运行的时候直接运行机器码，这样一来，运行的效率就提高了很多。

但是这样又回造成另外的问题。因为第一次要完全将java代码编译成机器码，所以安装时间非常长，而且编译之后App的磁盘空间占用会极速膨胀，一般会变大1-3倍。所以造成了安装缓慢，开机缓慢，磁盘空间不够用的缺点。

#### 3

Google当然也知道这个问题。所以在Android 7.0之后继续优化了